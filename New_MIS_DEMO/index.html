<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microscope Control Interface</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #111; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #444; 
        }
        
        /* Slider Styles */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #9ca3af;
            border: 2px solid #4b5563;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #9ca3af;
            border: 2px solid #4b5563;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent;
            border-radius: 2px;
        }

        /* Animation Keyframes */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Maximize = (props) => <IconBase {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></IconBase>;
        const Grid = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>;
        const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></IconBase>;
        const Columns = (props) => <IconBase {...props}><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const List = (props) => <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>;
        const Disc = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;

        // --- Gemini API Helper ---
        const callGemini = async (prompt, systemInstruction = "") => {
            const apiKey = ""; // ⚠️ 請在此填入您的 API Key
            if (!apiKey) {
                if (apiKey === "") return null; 
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { responseMimeType: "application/json" }
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : null;
            } catch (error) {
                console.error("Gemini API Call Failed:", error);
                return null;
            }
        };

        const callGeminiText = async (prompt, systemInstruction = "") => {
            const apiKey = ""; // ⚠️ 請在此填入您的 API Key
            if (!apiKey) return "API Key missing. Please check code.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis failed.";
            } catch (error) {
                return "Error connecting to AI service.";
            }
        };

        // --- Custom Components ---

        const CustomSlider = ({ label, value, onChange, min = 0, max = 100 }) => (
            <div className="flex flex-col w-full px-2">
                <div className="text-gray-300 text-xs mb-1 text-center font-medium">{label}</div>
                <div className="relative w-full h-8 flex items-center justify-center">
                    <div className="absolute bottom-0 w-full flex justify-between px-1">
                        {[...Array(11)].map((_, i) => (
                            <div key={i} className={`h-1 w-px ${i % 5 === 0 ? 'h-2 bg-gray-400' : 'bg-gray-600'}`}></div>
                        ))}
                    </div>
                    <input
                        type="range"
                        min={min}
                        max={max}
                        value={value}
                        onChange={(e) => onChange(parseInt(e.target.value))}
                        className="z-10 w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none"
                    />
                    <div 
                        className="absolute left-0 h-1 bg-blue-500 rounded-l-lg top-1/2 transform -translate-y-1/2 pointer-events-none transition-all duration-500"
                        style={{ width: `${((value - min) / (max - min)) * 100}%` }}
                    ></div>
                </div>
            </div>
        );

        const DoubleSlider = ({ label }) => {
            const [val1, setVal1] = useState(60);
            const [val2, setVal2] = useState(40);
            return (
                <div className="flex flex-col w-full px-2">
                    <div className="text-gray-300 text-xs mb-1 text-center font-medium">{label}</div>
                    <div className="flex flex-col gap-2">
                        <div className="relative w-full h-4 flex items-center">
                            <div className="absolute w-full h-1 bg-gray-700 rounded"></div>
                            <div className="absolute h-1 bg-blue-500 rounded" style={{width: `${val1}%`}}></div>
                            <input type="range" value={val1} onChange={(e)=>setVal1(e.target.value)} className="absolute w-full opacity-0 cursor-pointer" />
                            <div className="w-3 h-3 bg-gray-400 rounded-full absolute pointer-events-none border border-gray-600" style={{left: `calc(${val1}% - 6px)`}}></div>
                        </div>
                        <div className="relative w-full h-4 flex items-center mt-1">
                            <div className="absolute w-full h-1 bg-gray-700 rounded"></div>
                            <div className="absolute h-1 bg-blue-500 rounded" style={{width: `${val2}%`}}></div>
                            <input type="range" value={val2} onChange={(e)=>setVal2(e.target.value)} className="absolute w-full opacity-0 cursor-pointer" />
                            <div className="w-3 h-3 bg-gray-400 rounded-full absolute pointer-events-none border border-gray-600" style={{left: `calc(${val2}% - 6px)`}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // New Dropdown Component for Viewport Mode
        const ViewportModeDropdown = ({ value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);
            const options = ['BEI L', 'BEI R', 'BEI', 'SEI', 'MIX'];

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            return (
                <div className="relative" ref={dropdownRef}>
                     <button 
                        onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }}
                        className="bg-gray-700/80 p-1 rounded text-gray-300 hover:bg-gray-600 hover:text-white border border-gray-600 flex flex-col items-center min-w-[40px]"
                     >
                        <div className="grid grid-cols-2 gap-0.5 mb-1">
                            <div className="w-1.5 h-1.5 bg-gray-400"></div><div className="w-1.5 h-1.5 bg-gray-500"></div>
                            <div className="w-1.5 h-1.5 bg-gray-500"></div><div className="w-1.5 h-1.5 bg-gray-400"></div>
                        </div>
                        <div className="text-[10px] flex items-center whitespace-nowrap px-1">{value} <span className="text-[8px] ml-0.5">▼</span></div>
                    </button>
                    {isOpen && (
                        <div className="absolute top-full left-0 mt-1 bg-[#2a2a2a] border border-gray-600 rounded shadow-xl z-50 w-24">
                            {options.map(opt => (
                                <button
                                    key={opt}
                                    onClick={(e) => { e.stopPropagation(); onChange(opt); setIsOpen(false); }}
                                    className={`block w-full text-left px-2 py-1 text-[10px] hover:bg-blue-600 hover:text-white ${value === opt ? 'text-blue-400' : 'text-gray-300'}`}
                                >
                                    {opt}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Viewport = ({ id, isActive, onClick, label, onLabelChange }) => (
            <div 
                onClick={onClick}
                className={`relative bg-[#2a2a2a] border-2 flex flex-col justify-between p-2 cursor-pointer transition-colors
                ${isActive ? 'border-blue-500' : 'border-gray-700 hover:border-gray-600'}`}
            >
                <div className="absolute top-2 left-2 flex flex-col gap-2 z-10">
                    <button className="bg-gray-700/80 p-1.5 rounded text-gray-300 hover:bg-gray-600 hover:text-white border border-gray-600">
                        <Save size={16} />
                        <span className="text-[10px] block text-center mt-0.5">Save</span>
                    </button>
                    <ViewportModeDropdown value={label} onChange={onLabelChange} />
                </div>
                <div className="absolute bottom-2 left-2 z-10">
                    <button className="bg-gray-700/80 p-1.5 rounded text-gray-300 hover:bg-gray-600 hover:text-white border border-gray-600">
                        <Maximize size={16} />
                        <span className="text-[10px] block text-center mt-0.5">This</span>
                    </button>
                </div>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
                    <div className="w-full h-px bg-blue-500/30"></div>
                    <div className="h-full w-px bg-blue-500/30 absolute"></div>
                </div>
            </div>
        );

        // --- Interactive Knob Component (Fixed Rotation) ---
        const InteractiveKnob = ({ value, onChange, min, max }) => {
            const knobRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);

            const valueToDegrees = (v) => {
                const percentage = (v - min) / (max - min);
                return -135 + percentage * 270;
            };

            const degreesToValue = (d) => {
                let clamped = d;
                if (d < -135) clamped = -135;
                if (d > 135) clamped = 135;
                const percentage = (clamped + 135) / 270;
                return Math.round(min + percentage * (max - min));
            };

            const handleMouseDown = (e) => {
                setIsDragging(true);
                updateValueFromMouse(e);
            };

            const updateValueFromMouse = (e) => {
                if (!knobRef.current) return;
                const rect = knobRef.current.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const angleRad = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                let angleDeg = angleRad * (180 / Math.PI);
                angleDeg += 90; 
                if (angleDeg > 180) angleDeg -= 360;

                const newValue = degreesToValue(angleDeg);
                onChange(newValue);
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        updateValueFromMouse(e);
                    }
                };
                const handleMouseUp = () => {
                    setIsDragging(false);
                };

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging]);

            const rotation = valueToDegrees(value);
            const percentage = ((value - min) / (max - min)) * 100;

            return (
                <div 
                    ref={knobRef}
                    onMouseDown={handleMouseDown}
                    className="relative w-24 h-24 rounded-full bg-gradient-to-b from-gray-700 to-gray-800 shadow-[inset_0_4px_10px_rgba(0,0,0,0.5)] flex items-center justify-center border border-gray-700 cursor-grab active:cursor-grabbing group"
                >
                    {/* Fix: SVG rotated 135deg. 
                       SVG 'start' is usually 3 o'clock. 
                       Rotate 135deg -> Start moves to 7:30 position (which corresponds to -135deg on our knob).
                    */}
                    <svg className="absolute w-full h-full transform rotate-[135deg] pointer-events-none">
                        <circle cx="48" cy="48" r="40" stroke="#1f2937" strokeWidth="6" fill="none"/>
                        <circle cx="48" cy="48" r="40" stroke="#3b82f6" strokeWidth="6" fill="none"
                            strokeDasharray="251"
                            strokeDashoffset={251 - (251 * percentage * 0.75) / 100} 
                            strokeLinecap="round"
                            className="transition-all duration-75 ease-out"
                        />
                    </svg>
                    <div className="w-16 h-16 rounded-full bg-[#333] shadow-[0_4px_6px_rgba(0,0,0,0.6)] flex items-center justify-center relative group-active:scale-95 transition-transform">
                        <div 
                            className="w-1.5 h-1.5 bg-blue-400 rounded-full absolute top-2 transition-transform duration-75 ease-out origin-center box-border"
                            style={{ transformOrigin: "50% 32px", transform: `rotate(${rotation}deg)` }}
                        ></div>
                        <div className="w-2 h-2 bg-gray-600 rounded-full inset-shadow"></div>
                    </div>
                </div>
            );
        };

        // --- View Dropdown Component ---
        const ViewDropdown = ({ currentMode, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleSelect = (mode) => {
                onChange(mode);
                setIsOpen(false);
            };

            const getIcon = (mode) => {
                if (mode === 1) return <Square size={16} />;
                if (mode === 2) return <Columns size={16} />;
                return <Grid size={16} />;
            };

            return (
                <div className="relative w-full px-2" ref={dropdownRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full bg-gray-700/50 hover:bg-gray-600 border border-blue-500/30 rounded-lg p-2 flex flex-col items-center gap-1 transition-all"
                    >
                        <div className="flex items-center justify-between w-full px-1">
                            <div className="text-blue-400">{getIcon(currentMode)}</div>
                            <ChevronDown size={14} className={`text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                        </div>
                        <div className="text-[10px] text-gray-200 font-semibold w-full text-left px-1">
                            View: {currentMode}
                        </div>
                    </button>

                    {isOpen && (
                        <div className="absolute top-full left-0 mt-1 w-full bg-[#2a2a2a] border border-gray-600 rounded-lg shadow-xl z-50 overflow-hidden flex flex-col">
                            {[1, 2, 4].map(mode => (
                                <button 
                                    key={mode}
                                    onClick={() => handleSelect(mode)}
                                    className={`flex items-center gap-2 p-2 text-xs hover:bg-blue-600 hover:text-white transition-colors
                                    ${currentMode === mode ? 'bg-blue-900/30 text-blue-400' : 'text-gray-300'}`}
                                >
                                    {getIcon(mode)}
                                    <span>View: {mode}</span>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- AI Panel Component ---
        const AIPanel = ({ isOpen, onClose, onOptimize, onAnalyze, isLoading, aiResponse }) => {
            const [prompt, setPrompt] = useState('');

            if (!isOpen) return null;

            return (
                <div className="absolute top-4 left-28 z-50 w-80 bg-[#1f1f1f]/95 border border-blue-500/50 rounded-lg shadow-2xl backdrop-blur-sm flex flex-col overflow-hidden text-sm animate-in fade-in slide-in-from-left-4 duration-300">
                    <div className="bg-gradient-to-r from-blue-900/50 to-[#1f1f1f] p-3 border-b border-gray-700 flex justify-between items-center">
                        <div className="flex items-center gap-2 text-blue-400 font-bold">
                            <Sparkles size={16} />
                            <span>Gemini AI Assistant</span>
                        </div>
                        <button onClick={onClose} className="text-gray-400 hover:text-white"><X size={16}/></button>
                    </div>
                    
                    <div className="p-4 flex flex-col gap-4">
                        <div>
                            <label className="text-gray-300 block mb-2 font-medium">Auto-Tune Parameters</label>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={prompt}
                                    onChange={(e) => setPrompt(e.target.value)}
                                    placeholder="e.g., 'Biological Tissue', 'Gold Surface'..."
                                    className="flex-1 bg-[#2a2a2a] border border-gray-600 rounded px-2 py-1.5 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-blue-500"
                                    onKeyDown={(e) => e.key === 'Enter' && onOptimize(prompt)}
                                />
                                <button 
                                    onClick={() => onOptimize(prompt)}
                                    disabled={isLoading}
                                    className="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isLoading ? <div className="animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"></div> : <Zap size={16} />}
                                </button>
                            </div>
                            <p className="text-[10px] text-gray-500 mt-1 ml-1">Describe your sample to auto-set voltages & magnification.</p>
                        </div>
                        <div className="h-px bg-gray-700 w-full"></div>
                        <div>
                            <button 
                                onClick={onAnalyze}
                                disabled={isLoading}
                                className="w-full flex items-center justify-center gap-2 bg-[#2a2a2a] hover:bg-[#333] border border-gray-600 text-gray-300 py-2 rounded transition-colors disabled:opacity-50"
                            >
                                <Activity size={16} className={isLoading ? "animate-pulse" : ""} />
                                {isLoading ? "Analyzing..." : "Analyze Current Status"}
                            </button>
                        </div>
                        {aiResponse && (
                            <div className="bg-[#111] border border-gray-800 rounded p-3 text-xs text-gray-300 leading-relaxed max-h-40 overflow-y-auto custom-scrollbar">
                                <div className="flex items-start gap-2">
                                    <MessageSquare size={14} className="mt-0.5 text-blue-400 shrink-0" />
                                    <p>{aiResponse}</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [layoutMode, setLayoutMode] = useState(2);
            const [activeView, setActiveView] = useState(0);
            const [brightness, setBrightness] = useState(50);
            const [contrast, setContrast] = useState(50);
            const [angle, setAngle] = useState(0);
            const [magnification, setMagnification] = useState(800);
            const [isScanning, setIsScanning] = useState(false);
            const [vacuumOn, setVacuumOn] = useState(true);
            const [hvOn, setHvOn] = useState(false);
            const [scanSpeed, setScanSpeed] = useState('Mid.');
            
            // Viewport modes state
            const [viewportModes, setViewportModes] = useState(['BEI L', 'BEI R', 'BEI', 'BEI']);

            const [aiPanelOpen, setAiPanelOpen] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiResponse, setAiResponse] = useState("Ready to assist. Ask me to optimize settings or analyze current status.");

            const handleAIOptimize = async (userPrompt) => {
                if (!userPrompt.trim()) return;
                setAiLoading(true);
                setAiResponse("Optimizing instrument parameters for: " + userPrompt + "...");
                const systemPrompt = `You are an expert operator of a Scanning Electron Microscope (SEM). Based on the user's description of a sample, you MUST return a JSON object containing optimal settings. Output JSON format ONLY (no markdown).`;
                const result = await callGemini(userPrompt, systemPrompt);
                if (result) {
                    if (result.brightness !== undefined) setBrightness(result.brightness);
                    if (result.contrast !== undefined) setContrast(result.contrast);
                    if (result.angle !== undefined) setAngle(result.angle);
                    if (result.magnification !== undefined) setMagnification(result.magnification);
                    if (result.highVoltage !== undefined) setHvOn(result.highVoltage);
                    if (result.vacuum !== undefined) setVacuumOn(result.vacuum);
                    if (result.scanSpeed) setScanSpeed(result.scanSpeed);
                    setAiResponse(`✅ Parameters optimized for ${userPrompt}.\n\nAI Reasoning: ${result.reasoning}`);
                } else {
                    setAiResponse("❌ Failed to generate settings. Please check if API Key is set in the code.");
                }
                setAiLoading(false);
            };

            const handleAIAnalyze = async () => {
                setAiLoading(true);
                const currentStatus = `HV: ${hvOn}; Vacuum: ${vacuumOn}; Mag: ${magnification}x; Speed: ${scanSpeed}; Angle: ${angle}; Bri: ${brightness}; Con: ${contrast};`;
                const systemPrompt = "Analyze current SEM status professionally and concisely.";
                const text = await callGeminiText(currentStatus, systemPrompt);
                setAiResponse(text);
                setAiLoading(false);
            };

            const updateViewportMode = (idx, mode) => {
                const newModes = [...viewportModes];
                newModes[idx] = mode;
                setViewportModes(newModes);
            };

            const renderViewports = () => {
                const viewports = [];
                for (let i = 0; i < layoutMode; i++) {
                    viewports.push(
                        <Viewport 
                            key={i} 
                            id={i} 
                            isActive={activeView === i} 
                            onClick={() => setActiveView(i)}
                            label={viewportModes[i] || 'BEI'}
                            onLabelChange={(newMode) => updateViewportMode(i, newMode)}
                        />
                    );
                }
                return viewports;
            };

            const getGridClass = () => {
                switch(layoutMode) {
                    case 1: return "grid-cols-1 grid-rows-1";
                    case 2: return "grid-cols-2 grid-rows-1";
                    case 4: return "grid-cols-2 grid-rows-2";
                    default: return "grid-cols-2 grid-rows-1";
                }
            };

            return (
                <div className="flex h-screen w-screen bg-[#1a1a1a] text-gray-200 font-sans overflow-hidden select-none relative">
                    <AIPanel 
                        isOpen={aiPanelOpen} 
                        onClose={() => setAiPanelOpen(false)}
                        onOptimize={handleAIOptimize}
                        onAnalyze={handleAIAnalyze}
                        isLoading={aiLoading}
                        aiResponse={aiResponse}
                    />

                    {/* Left Sidebar */}
                    <div className="w-24 bg-[#252525] border-r border-gray-700 flex flex-col items-center py-4 gap-4 z-20 shadow-xl">
                        <div className="mb-4 text-blue-400">
                            <Disc size={48} className="animate-pulse-slow" />
                        </div>

                        <ViewDropdown currentMode={layoutMode} onChange={setLayoutMode} />

                        <nav className="flex flex-col w-full px-2 gap-3 mt-2">
                            {[
                                { icon: Activity, label: "Status" },
                                { icon: List, label: "Position" },
                                { icon: Settings, label: "Settings" }
                            ].map((item, idx) => (
                                <button key={idx} className="flex flex-col items-center justify-center w-full aspect-square bg-gray-700/50 hover:bg-gray-600 rounded-lg border border-gray-600 transition-all group">
                                    <item.icon size={28} className="text-gray-400 group-hover:text-blue-400 mb-1" />
                                    <span className="text-xs font-medium text-gray-300">{item.label}</span>
                                </button>
                            ))}
                            
                            <button 
                                onClick={() => setAiPanelOpen(!aiPanelOpen)}
                                className={`flex flex-col items-center justify-center w-full aspect-square rounded-lg border transition-all group relative overflow-hidden
                                ${aiPanelOpen ? 'bg-blue-600 border-blue-400 text-white' : 'bg-gradient-to-br from-indigo-900 to-purple-900 border-indigo-500/50 text-indigo-200 hover:border-indigo-400'}`}
                            >
                                <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <Sparkles size={28} className={aiPanelOpen ? "" : "animate-pulse"} />
                                <span className="text-[10px] font-bold mt-1">AI Assistant</span>
                            </button>
                        </nav>

                        <div className="flex-grow"></div>

                        <div className="flex flex-col items-center mt-auto mb-2">
                            <User size={32} className="text-gray-500 mb-1" />
                            <span className="text-sm font-bold text-gray-300">admin</span>
                            <span className="text-[10px] text-gray-600 mt-1">ver. 1.0</span>
                        </div>
                    </div>

                    {/* Center Area */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden p-1">
                        <div className={`flex-1 grid gap-1 p-1 bg-[#202020] rounded-t-lg border border-gray-800 ${getGridClass()}`}>
                            {renderViewports()}
                        </div>

                        <div className="h-32 bg-[#2a2a2a] rounded-b-lg border-t border-gray-700 flex items-center px-4 gap-4 shadow-lg z-10">
                            <div className="flex-1 grid grid-cols-4 gap-4">
                                <CustomSlider label="Brightness" value={brightness} onChange={setBrightness} />
                                <CustomSlider label="Contrast" value={contrast} onChange={setContrast} />
                                <CustomSlider label="Angle" value={angle} onChange={setAngle} min={-180} max={180} />
                                <DoubleSlider label="Focus" />
                            </div>
                        </div>
                    </div>

                    {/* Right Sidebar */}
                    <div className="w-64 bg-[#252525] border-l border-gray-700 flex flex-col p-3 gap-3 overflow-y-auto">
                        
                        <div className="bg-[#2e2e2e] p-3 rounded-lg border border-gray-600 shadow-md">
                            <div className="text-sm text-gray-200 mb-2 font-medium">Vacuum Pumping</div>
                            
                            {/* Updated Vacuum Toggle to match High Voltage Style */}
                            <div className="w-full flex justify-center mb-3">
                                <div 
                                    className={`w-32 h-8 rounded-full p-1 cursor-pointer transition-colors duration-300 flex items-center bg-gray-700 border border-gray-600`}
                                    onClick={() => setVacuumOn(!vacuumOn)}
                                >
                                    <div className={`h-6 w-12 rounded-full shadow-md transform transition-all duration-300 ${vacuumOn ? 'translate-x-16 bg-yellow-500' : 'translate-x-0 bg-gray-500'}`}></div>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <div className="flex items-center justify-between text-xs text-gray-400">
                                    <span>E-Gun</span>
                                    <div className="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                                        <div className={`h-full bg-green-400 w-3/4 transition-all duration-1000 ${hvOn ? 'opacity-100' : 'opacity-30'}`}></div>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between text-xs text-gray-400">
                                    <span>Chamber</span>
                                    <div className="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                                        <div className={`h-full bg-green-500 w-full ${vacuumOn ? 'animate-pulse' : 'opacity-30'}`}></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-[#2e2e2e] p-3 rounded-lg border border-gray-600 shadow-md text-center">
                            <div className="text-sm text-gray-200 mb-1 font-medium">High Voltage</div>
                            <div className={`text-xs mb-2 transition-colors ${hvOn ? 'text-red-400 font-bold' : 'text-gray-500'}`}>{hvOn ? '15kV (ACTIVE)' : 'OFF'}</div>
                            <div 
                                className={`w-32 mx-auto h-8 rounded-full p-1 cursor-pointer transition-colors duration-300 flex items-center bg-gray-700 border border-gray-600`}
                                onClick={() => setHvOn(!hvOn)}
                            >
                                <div className={`h-6 w-12 rounded-full shadow-md transform transition-all duration-300 ${hvOn ? 'translate-x-16 bg-green-500' : 'translate-x-0 bg-gray-500'}`}></div>
                            </div>
                        </div>

                        <div className="bg-[#2e2e2e] p-1 rounded-lg border border-blue-500 shadow-md">
                            <button 
                                onClick={() => setIsScanning(!isScanning)}
                                className={`w-full h-24 rounded flex flex-col items-center justify-center transition-all ${isScanning ? 'bg-gray-700' : 'bg-[#333] hover:bg-[#3a3a3a]'}`}
                            >
                                <div className="text-3xl text-white font-light tracking-widest mb-1">Scan</div>
                                <div className="text-sm text-gray-400 flex items-center gap-2">
                                    {isScanning ? <Pause size={14}/> : <Play size={14}/>}
                                    {isScanning ? "Pause" : "Play/Pause"}
                                </div>
                            </button>
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                            {['Fast', 'Mid.', 'SLow'].map(speed => (
                                <button 
                                    key={speed}
                                    onClick={() => setScanSpeed(speed)}
                                    className={`py-1.5 px-1 rounded text-xs font-medium border ${scanSpeed === speed ? 'bg-blue-600 border-blue-400 text-white' : 'bg-[#2e2e2e] border-gray-600 text-gray-400 hover:bg-gray-700'}`}
                                >
                                    {speed}
                                </button>
                            ))}
                        </div>

                        <div className="bg-[#2e2e2e] p-4 rounded-lg border border-gray-600 shadow-md flex flex-col items-center flex-1">
                            <div className="text-sm text-gray-200 mb-4 font-medium">Magnification</div>
                            <div className="mb-6">
                                <InteractiveKnob value={magnification} onChange={setMagnification} min={100} max={20000} />
                            </div>
                            
                            <div className="flex items-center justify-between w-full gap-2">
                                <button 
                                    onClick={() => setMagnification(m => Math.max(100, m - 100))}
                                    className="w-10 h-10 bg-gray-600 rounded flex items-center justify-center text-white hover:bg-gray-500 active:bg-gray-700 shadow-md"
                                >-</button>
                                <div className="text-xl font-light text-white w-20 text-center">{magnification}x</div>
                                <button 
                                    onClick={() => setMagnification(m => Math.min(20000, m + 100))}
                                    className="w-10 h-10 bg-gray-600 rounded flex items-center justify-center text-white hover:bg-gray-500 active:bg-gray-700 shadow-md"
                                >+</button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>