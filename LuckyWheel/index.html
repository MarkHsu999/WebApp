<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸運大轉盤 - 分頁優化版</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 Canvas Confetti 煙火特效庫 -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* 自定義捲軸樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
        /* 獎項彈出動畫 */
        @keyframes prize-pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-prize {
            animation: prize-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        /* 側邊欄過渡 */
        .sidebar-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body id="app-body" class="bg-slate-900 text-slate-100 font-sans overflow-hidden transition-colors duration-500">

    <div id="app" class="min-h-screen flex h-screen overflow-hidden">
        
        <!-- 左側：控制面板 -->
        <div id="sidebar" class="sidebar-transition w-full md:w-1/3 lg:w-1/4 bg-slate-800 flex flex-col shadow-xl z-20 border-r border-slate-700 h-full overflow-hidden shrink-0 relative">
            
            <!-- 標題與分頁切換 -->
            <div class="p-6 pb-2">
                <h1 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-400">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    控制面板
                </h1>
                
                <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700">
                    <button id="tab-btn-list" class="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-medium rounded-md transition-all bg-yellow-500 text-slate-900">
                        <i data-lucide="list" class="w-4 h-4"></i> 名單
                    </button>
                    <button id="tab-btn-settings" class="flex-1 flex items-center justify-center gap-2 py-2 text-sm font-medium rounded-md transition-all text-slate-400 hover:text-white">
                        <i data-lucide="settings" class="w-4 h-4"></i> 設定
                    </button>
                </div>
            </div>

            <!-- 分頁內容容器 -->
            <div class="flex-1 overflow-hidden flex flex-col p-6 pt-2">
                
                <!-- 名單分頁 -->
                <div id="tab-content-list" class="flex flex-col h-full space-y-4">
                    <!-- 新增表單 -->
                    <form id="add-form" class="flex gap-2">
                        <input
                            type="text"
                            id="new-item-input"
                            placeholder="輸入名字..."
                            class="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-yellow-400 text-white"
                        />
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-slate-900 p-2 rounded transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </form>

                    <!-- 名單操作按鈕 -->
                    <div class="grid grid-cols-2 gap-2">
                        <button id="select-all-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs py-1.5 rounded border border-slate-600 flex items-center justify-center gap-1">
                            <i data-lucide="check-square" class="w-3 h-3"></i> 全選
                        </button>
                        <button id="unselect-all-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs py-1.5 rounded border border-slate-600 flex items-center justify-center gap-1">
                            <i data-lucide="square" class="w-3 h-3"></i> 取消
                        </button>
                    </div>

                    <!-- 列表區域 -->
                    <div id="items-list" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                        <!-- 項目由 JS 生成 -->
                    </div>

                    <div class="pt-2 flex justify-between items-center border-t border-slate-700">
                        <span id="stats-text" class="text-[11px] text-slate-500 uppercase tracking-tighter font-bold"></span>
                        <button id="clear-list-btn" class="text-[11px] text-red-400/70 hover:text-red-400 flex items-center gap-1 transition-colors">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> 清除全部
                        </button>
                    </div>
                </div>

                <!-- 設定分頁 -->
                <div id="tab-content-settings" class="hidden flex flex-col space-y-6">
                    
                    <!-- 檔案操作 -->
                    <section>
                        <label class="block text-[10px] text-slate-500 mb-2 uppercase tracking-widest font-bold">檔案管理</label>
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="file" id="csv-upload" accept=".csv,.txt" class="hidden">
                                <button id="import-csv-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs py-2 rounded border border-slate-600 flex items-center justify-center gap-1.5">
                                    <i data-lucide="file-text" class="w-3.5 h-3.5"></i> 匯入名單
                                </button>
                                
                                <input type="file" id="config-upload" accept=".json" class="hidden">
                                <button id="import-config-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs py-2 rounded border border-slate-600 flex items-center justify-center gap-1.5">
                                    <i data-lucide="folder-input" class="w-3.5 h-3.5"></i> 載入設定
                                </button>
                            </div>
                            <button id="export-config-btn" class="w-full bg-slate-700 hover:bg-blue-600/30 text-blue-300 text-xs py-2 rounded border border-slate-600 hover:border-blue-500/50 flex items-center justify-center gap-2 transition-all">
                                <i data-lucide="save" class="w-3.5 h-3.5"></i> 匯出完整設定檔 (.json)
                            </button>
                        </div>
                    </section>

                    <!-- 背景顏色 -->
                    <section>
                        <label class="block text-[10px] text-slate-500 mb-2 uppercase tracking-widest font-bold">環境視覺</label>
                        <div class="flex items-center gap-3 bg-slate-900/40 p-3 rounded border border-slate-700">
                            <input type="color" id="bg-color-picker" value="#0f172a" class="w-10 h-10 bg-transparent border-none cursor-pointer rounded overflow-hidden">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-500 font-bold uppercase">背景顏色</span>
                                <span id="bg-color-hex" class="text-xs font-mono text-slate-300">#0F172A</span>
                            </div>
                        </div>
                    </section>

                    <!-- 功能開關 -->
                    <section class="space-y-4">
                        <label class="block text-[10px] text-slate-500 mb-2 uppercase tracking-widest font-bold">功能開關</label>
                        
                        <label class="flex items-center justify-between p-3 bg-slate-900/40 rounded border border-slate-700 cursor-pointer group">
                            <span id="remove-on-win-text" class="text-sm text-slate-400 group-hover:text-slate-200 transition-colors">中獎後取消勾選</span>
                            <div class="relative">
                                <input type="checkbox" id="remove-on-win-checkbox" class="sr-only peer">
                                <div class="w-10 h-6 bg-slate-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-yellow-400/50 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500 transition-all"></div>
                            </div>
                        </label>

                        <label class="flex items-center justify-between p-3 bg-slate-900/40 rounded border border-slate-700 cursor-pointer group">
                            <div class="flex flex-col">
                                <span id="sound-enabled-text" class="text-sm text-yellow-400 font-medium">開啟音效</span>
                            </div>
                            <div class="relative">
                                <input type="checkbox" id="sound-enabled-checkbox" class="sr-only peer" checked>
                                <div class="w-10 h-6 bg-slate-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-yellow-400/50 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500 transition-all"></div>
                            </div>
                        </label>
                    </section>
                </div>

            </div>
        </div>

        <!-- 右側：轉盤顯示區 -->
        <div id="main-content" class="flex-1 relative flex flex-col items-center justify-around p-4 md:p-8 overflow-hidden h-full">
            
            <!-- 側邊欄切換按鈕 -->
            <button id="toggle-sidebar-btn" class="absolute top-6 left-6 z-30 bg-slate-800 hover:bg-slate-700 border border-slate-600 p-2.5 rounded-full shadow-lg transition-all text-yellow-400 group">
                <i data-lucide="menu" id="toggle-icon" class="w-6 h-6"></i>
            </button>

            <!-- 可編輯標題區 -->
            <div class="w-full text-center px-4 mt-8 md:mt-0">
                <h2 
                    id="editable-title" 
                    contenteditable="true" 
                    class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-500 drop-shadow-lg outline-none cursor-text select-none hover:opacity-80 transition-opacity"
                    title="點擊編輯標題"
                >
                    幸運大轉盤
                </h2>
                <p class="text-slate-500 text-xs md:text-sm mt-2 opacity-50 font-medium italic">點擊文字即可修改標題</p>
            </div>

            <!-- 轉盤容器 -->
            <div class="relative w-full max-w-[280px] md:max-w-[480px] aspect-square flex items-center justify-center">
                <div class="absolute top-1/2 -right-6 -translate-y-1/2 z-20 filter drop-shadow-lg">
                    <div class="w-0 h-0 border-t-[15px] border-t-transparent border-b-[15px] border-b-transparent border-r-[30px] border-r-red-500"></div>
                </div>

                <div 
                    id="wheel-rotate-layer"
                    class="w-full h-full rounded-full shadow-[0_0_60px_rgba(0,0,0,0.5)] border-8 border-slate-800 relative overflow-hidden transform"
                    style="transform: rotate(0deg);"
                >
                    <svg id="wheel-svg" viewBox="-1 -1 2 2" class="w-full h-full transform -rotate-90"></svg>
                    <div id="empty-state" class="hidden w-full h-full bg-slate-800 flex items-center justify-center text-slate-500 font-bold absolute top-0 left-0">
                        請選擇項目
                    </div>
                </div>

                <button
                    id="spin-btn"
                    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-20 h-20 md:w-24 md:h-24 rounded-full border-8 border-slate-800 flex items-center justify-center font-black text-xl shadow-2xl z-30 transition-all bg-white text-slate-900 hover:scale-110 active:scale-95 hover:bg-yellow-400"
                >
                    SPIN
                </button>
            </div>
            
            <!-- 中獎結果顯示 -->
            <div class="flex flex-col items-center">
                <div id="winner-display" class="z-50 opacity-0 pointer-events-none transition-all duration-300 h-24 flex items-center justify-center">
                    <div class="bg-gradient-to-r from-red-600 to-yellow-500 text-white px-8 py-4 rounded-full shadow-[0_0_50px_rgba(234,179,8,0.6)] text-center border-4 border-yellow-300">
                        <div class="text-[10px] font-black uppercase tracking-widest mb-1 text-yellow-200">CONGRATULATIONS</div>
                        <div class="text-3xl md:text-5xl font-black flex items-center justify-center gap-3 drop-shadow-md">
                            <i data-lucide="party-popper" class="w-8 h-8 md:w-10 md:h-10 text-yellow-200"></i>
                            <span id="winner-name"></span>
                            <i data-lucide="party-popper" class="w-8 h-8 md:w-10 md:h-10 text-yellow-200"></i>
                        </div>
                    </div>
                </div>

                <p id="hint-text" class="mt-4 text-slate-500 text-xs md:text-sm hidden md:block italic">
                    Ready to win? Click the center to spin!
                </p>
            </div>
        </div>
    </div>

    <!-- 通用確認 Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 opacity-0 pointer-events-none transition-opacity duration-200">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform scale-90 transition-transform duration-200">
            <div class="flex items-center gap-3 text-red-400 mb-4" id="modal-header">
                <i data-lucide="alert-circle" class="w-6 h-6"></i>
                <h3 class="text-xl font-bold" id="modal-title">確認操作</h3>
            </div>
            <p class="text-slate-300 mb-6" id="modal-body"></p>
            <div class="flex flex-col gap-3" id="modal-actions"></div>
        </div>
    </div>

    <script>
        // --- 狀態管理 ---
        const state = {
            items: [
                { id: 1, text: '吃大餐', checked: true },
                { id: 2, text: '抽大獎', checked: true },
                { id: 3, text: '放長假', checked: true },
                { id: 4, text: '加薪水', checked: true },
                { id: 5, text: '買新車', checked: true },
                { id: 6, text: '環遊世界', checked: true },
            ],
            isSpinning: false,
            rotation: 0,
            winner: null,
            removeOnWin: false,
            soundEnabled: true,
            isSidebarOpen: true,
            activeTab: 'list', // list or settings
            lastTickIndex: -1,
            bgColor: '#0f172a' 
        };

        const COLORS = [
            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', 
            '#EC4899', '#F97316', '#06B6D4', '#6366F1', '#D946EF'
        ];

        // --- 音效模組 ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTickSound() {
            if (!state.soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        const cheerAudio = new Audio('https://www.soundjay.com/human/applause-01.mp3');
        cheerAudio.volume = 0.5;

        // --- DOM 元素 ---
        const els = {
            body: document.getElementById('app-body'),
            sidebar: document.getElementById('sidebar'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
            toggleIcon: document.getElementById('toggle-icon'),
            editableTitle: document.getElementById('editable-title'),
            itemList: document.getElementById('items-list'),
            statsText: document.getElementById('stats-text'),
            addForm: document.getElementById('add-form'),
            input: document.getElementById('new-item-input'),
            removeCheckbox: document.getElementById('remove-on-win-checkbox'),
            removeText: document.getElementById('remove-on-win-text'),
            soundCheckbox: document.getElementById('sound-enabled-checkbox'),
            soundText: document.getElementById('sound-enabled-text'),
            bgColorPicker: document.getElementById('bg-color-picker'),
            bgColorHex: document.getElementById('bg-color-hex'),
            selectAllBtn: document.getElementById('select-all-btn'),
            unselectAllBtn: document.getElementById('unselect-all-btn'),
            clearListBtn: document.getElementById('clear-list-btn'),
            wheelSvg: document.getElementById('wheel-svg'),
            wheelLayer: document.getElementById('wheel-rotate-layer'),
            emptyState: document.getElementById('empty-state'),
            spinBtn: document.getElementById('spin-btn'),
            hintText: document.getElementById('hint-text'),
            winnerDisplay: document.getElementById('winner-display'),
            winnerName: document.getElementById('winner-name'),
            csvInput: document.getElementById('csv-upload'),
            importCsvBtn: document.getElementById('import-csv-btn'),
            configInput: document.getElementById('config-upload'),
            importConfigBtn: document.getElementById('import-config-btn'),
            exportConfigBtn: document.getElementById('export-config-btn'),
            // 分頁按鈕
            tabBtnList: document.getElementById('tab-btn-list'),
            tabBtnSettings: document.getElementById('tab-btn-settings'),
            // 分頁內容
            tabContentList: document.getElementById('tab-content-list'),
            tabContentSettings: document.getElementById('tab-content-settings'),
            // Modal
            modal: document.getElementById('confirm-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalActions: document.getElementById('modal-actions'),
            modalHeader: document.getElementById('modal-header')
        };

        // --- 功能模組 ---

        function switchTab(tab) {
            state.activeTab = tab;
            if (tab === 'list') {
                els.tabContentList.classList.remove('hidden');
                els.tabContentSettings.classList.add('hidden');
                els.tabBtnList.classList.add('bg-yellow-500', 'text-slate-900');
                els.tabBtnList.classList.remove('text-slate-400', 'hover:text-white');
                els.tabBtnSettings.classList.remove('bg-yellow-500', 'text-slate-900');
                els.tabBtnSettings.classList.add('text-slate-400', 'hover:text-white');
            } else {
                els.tabContentList.classList.add('hidden');
                els.tabContentSettings.classList.remove('hidden');
                els.tabBtnSettings.classList.add('bg-yellow-500', 'text-slate-900');
                els.tabBtnSettings.classList.remove('text-slate-400', 'hover:text-white');
                els.tabBtnList.classList.remove('bg-yellow-500', 'text-slate-900');
                els.tabBtnList.classList.add('text-slate-400', 'hover:text-white');
            }
        }

        function triggerCelebrate() {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            if (state.soundEnabled) {
                cheerAudio.currentTime = 0;
                cheerAudio.play().catch(e => console.log("Audio play blocked"));
            }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: ['#ff0000', '#ffd700', '#ffffff'] }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: ['#ff0000', '#ffd700', '#ffffff'] }));
            }, 250);
        }

        function monitorTicks(activeCount) {
            if (!state.isSpinning) return;
            const style = window.getComputedStyle(els.wheelLayer);
            const matrix = new WebKitCSSMatrix(style.transform);
            const angle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
            const normalizedAngle = (angle < 0 ? angle + 360 : angle);
            const sliceSize = 360 / activeCount;
            const currentIdx = Math.floor(((90 - normalizedAngle) % 360 + 360) % 360 / sliceSize);
            if (currentIdx !== state.lastTickIndex) {
                playTickSound();
                state.lastTickIndex = currentIdx;
            }
            requestAnimationFrame(() => monitorTicks(activeCount));
        }

        function toggleSidebar() {
            state.isSidebarOpen = !state.isSidebarOpen;
            if (state.isSidebarOpen) {
                els.sidebar.style.marginLeft = "0";
                els.toggleIcon.setAttribute('data-lucide', 'menu');
            } else {
                els.sidebar.style.marginLeft = `-${els.sidebar.offsetWidth}px`;
                els.toggleIcon.setAttribute('data-lucide', 'settings');
            }
            lucide.createIcons();
        }

        function toggleModal(show, config = {}) {
            if (show) {
                els.modalTitle.textContent = config.title || '確認操作';
                els.modalBody.textContent = config.body || '';
                els.modalActions.innerHTML = '';
                if (config.isWarning) {
                    els.modalHeader.classList.replace('text-yellow-400', 'text-red-400');
                } else {
                    els.modalHeader.classList.replace('text-red-400', 'text-yellow-400');
                }
                config.buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = `w-full py-2 rounded font-bold transition-colors ${btn.class || 'bg-slate-700 text-white hover:bg-slate-600'}`;
                    b.textContent = btn.text;
                    b.onclick = () => { btn.onClick(); toggleModal(false); };
                    els.modalActions.appendChild(b);
                });
                els.modal.classList.remove('pointer-events-none', 'opacity-0');
                els.modal.querySelector('div').classList.replace('scale-90', 'scale-100');
            } else {
                els.modal.classList.add('pointer-events-none', 'opacity-0');
                els.modal.querySelector('div').classList.replace('scale-100', 'scale-90');
            }
        }

        // --- 核心匯出/匯入邏輯 ---

        function exportConfig() {
            const configData = {
                version: "1.0",
                title: els.editableTitle.textContent.trim(),
                bgColor: state.bgColor,
                items: state.items,
                settings: {
                    removeOnWin: state.removeOnWin,
                    soundEnabled: state.soundEnabled
                }
            };
            const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileName = `lucky_wheel_config_${new Date().toISOString().slice(0, 10)}.json`;
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfig(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                if (data.items) state.items = data.items;
                if (data.title) els.editableTitle.textContent = data.title;
                if (data.bgColor) {
                    state.bgColor = data.bgColor;
                    els.body.style.backgroundColor = state.bgColor;
                    els.bgColorPicker.value = state.bgColor;
                    els.bgColorHex.textContent = state.bgColor.toUpperCase();
                }
                if (data.settings) {
                    state.removeOnWin = !!data.settings.removeOnWin;
                    state.soundEnabled = !!data.settings.soundEnabled;
                    els.removeCheckbox.checked = state.removeOnWin;
                    els.soundCheckbox.checked = state.soundEnabled;
                    updateUIFromSettings();
                }
                renderList();
                renderWheel();
            } catch (e) { console.error("載入設定檔失敗", e); }
        }

        function updateUIFromSettings() {
            if (els.removeText) {
                els.removeText.className = `text-sm transition-colors ${state.removeOnWin ? 'text-yellow-400 font-medium' : 'text-slate-400'}`;
            }
            if (els.soundText) {
                if (state.soundEnabled) {
                    els.soundText.classList.add('text-yellow-400', 'font-medium');
                    els.soundText.classList.remove('text-slate-400');
                    els.soundText.textContent = '開啟音效';
                } else {
                    els.soundText.classList.remove('text-yellow-400', 'font-medium');
                    els.soundText.classList.add('text-slate-400');
                    els.soundText.textContent = '音效已關閉';
                }
            }
            lucide.createIcons();
        }

        // --- 渲染邏輯 ---

        function renderList() {
            els.itemList.innerHTML = '';
            if (state.items.length === 0) {
                els.itemList.innerHTML = '<div class="text-center text-slate-500 py-8">名單是空的</div>';
            } else {
                state.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 rounded border transition-all duration-300 ${item.checked ? 'bg-slate-700 border-slate-600' : 'bg-slate-800/50 border-slate-700 opacity-50'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden cursor-pointer flex-1" onclick="toggleItem(${item.id})">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="w-4 h-4 accent-yellow-500 pointer-events-none" />
                            <span class="truncate no-select text-sm ${!item.checked ? 'line-through text-slate-500' : ''}">${item.text}</span>
                        </div>
                        <button onclick="deleteItem(${item.id})" class="text-slate-400 hover:text-red-400 p-1">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>`;
                    els.itemList.appendChild(div);
                });
            }
            els.statsText.textContent = `共 ${state.items.length} 項 | 選 ${state.items.filter(i => i.checked).length}`;
            lucide.createIcons();
        }

        function renderWheel() {
            const activeItems = state.items.filter(item => item.checked);
            const totalSlices = activeItems.length;
            els.wheelSvg.innerHTML = '';
            if (totalSlices === 0) {
                els.emptyState.classList.remove('hidden');
                els.wheelSvg.classList.add('hidden');
                els.spinBtn.disabled = true;
                return;
            }
            els.emptyState.classList.add('hidden');
            els.wheelSvg.classList.remove('hidden');
            if (!state.isSpinning) els.spinBtn.disabled = false;
            activeItems.forEach((item, index) => {
                const startPercent = index / totalSlices;
                const endPercent = (index + 1) / totalSlices;
                const [startX, startY] = [Math.cos(2 * Math.PI * startPercent), Math.sin(2 * Math.PI * startPercent)];
                const [endX, endY] = [Math.cos(2 * Math.PI * endPercent), Math.sin(2 * Math.PI * endPercent)];
                const color = COLORS[index % COLORS.length];
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                if (totalSlices === 1) {
                    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    c.setAttribute("r", "1"); c.setAttribute("fill", color); g.appendChild(c);
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    t.setAttribute("text-anchor", "middle"); t.setAttribute("dominant-baseline", "middle"); t.setAttribute("transform", "rotate(90)");
                    t.style.fontSize = "0.15px"; t.style.fill = "white"; t.textContent = item.text; g.appendChild(t);
                } else {
                    const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${endPercent - startPercent > 0.5 ? 1 : 0} 1 ${endX} ${endY} Z`;
                    const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    p.setAttribute("d", pathData); p.setAttribute("fill", color); p.setAttribute("stroke", "#1e293b"); p.setAttribute("stroke-width", "0.01"); g.appendChild(p);
                    const midP = (startPercent + endPercent) / 2;
                    const tx = Math.cos(2 * Math.PI * midP) * 0.65;
                    const ty = Math.sin(2 * Math.PI * midP) * 0.65;
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", tx); text.setAttribute("y", ty); text.setAttribute("text-anchor", "middle"); text.setAttribute("dominant-baseline", "middle");
                    text.setAttribute("transform", `rotate(${midP * 360} ${tx} ${ty})`);
                    text.style.fontSize = "0.1px"; text.style.fill = "white"; text.style.fontWeight = "bold";
                    text.textContent = item.text.length > 8 ? item.text.substring(0, 8) + '..' : item.text;
                    g.appendChild(text);
                }
                els.wheelSvg.appendChild(g);
            });
        }

        // --- 事件綁定 ---

        els.tabBtnList.onclick = () => switchTab('list');
        els.tabBtnSettings.onclick = () => switchTab('settings');
        els.toggleSidebarBtn.onclick = toggleSidebar;

        function toggleItem(id) {
            state.items = state.items.map(i => i.id === id ? { ...i, checked: !i.checked } : i);
            renderList(); renderWheel();
        }

        function deleteItem(id) {
            event.stopPropagation();
            state.items = state.items.filter(i => i.id !== id);
            renderList(); renderWheel();
        }

        els.bgColorPicker.oninput = (e) => {
            state.bgColor = e.target.value;
            els.body.style.backgroundColor = state.bgColor;
            els.bgColorHex.textContent = state.bgColor.toUpperCase();
        };

        els.clearListBtn.onclick = () => {
            if (state.items.length === 0) return;
            toggleModal(true, {
                title: '清除名單', body: '確定要清空所有項目嗎？', isWarning: true,
                buttons: [
                    { text: '確定清除', class: 'bg-red-600 text-white', onClick: () => { state.items = []; renderList(); renderWheel(); }},
                    { text: '取消', onClick: () => {} }
                ]
            });
        };

        els.importCsvBtn.onclick = () => els.csvInput.click();
        els.csvInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const names = ev.target.result.split(/\r?\n/).flatMap(l => l.split(',')).map(n => n.trim()).filter(n => n);
                const current = state.items.map(i => i.text.trim());
                const dupCount = names.filter(n => current.includes(n)).length;
                if (dupCount > 0) {
                    toggleModal(true, {
                        title: '偵測到重複', body: `名單中有 ${dupCount} 個項目重複，要如何處理？`,
                        buttons: [
                            { text: '只匯入新項', class: 'bg-yellow-500 text-slate-900', onClick: () => {
                                const news = names.filter(n => !current.includes(n));
                                state.items = [...state.items, ...news.map((t, idx) => ({ id: Date.now()+idx, text: t, checked: true }))];
                                renderList(); renderWheel();
                            }},
                            { text: '全部匯入', onClick: () => {
                                state.items = [...state.items, ...names.map((t, idx) => ({ id: Date.now()+idx, text: t, checked: true }))];
                                renderList(); renderWheel();
                            }},
                            { text: '取消', onClick: () => {} }
                        ]
                    });
                } else {
                    state.items = [...state.items, ...names.map((t, idx) => ({ id: Date.now()+idx, text: t, checked: true }))];
                    renderList(); renderWheel();
                }
                els.csvInput.value = '';
            };
            reader.readAsText(file);
        };

        els.importConfigBtn.onclick = () => els.configInput.click();
        els.configInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { importConfig(ev.target.result); els.configInput.value = ''; };
                reader.readAsText(file);
            }
        };
        els.exportConfigBtn.onclick = exportConfig;

        els.selectAllBtn.onclick = () => { state.items.forEach(i => i.checked = true); renderList(); renderWheel(); };
        els.unselectAllBtn.onclick = () => { state.items.forEach(i => i.checked = false); renderList(); renderWheel(); };
        els.addForm.onsubmit = (e) => {
            e.preventDefault();
            const t = els.input.value.trim();
            if (t) { state.items.push({ id: Date.now(), text: t, checked: true }); els.input.value = ''; renderList(); renderWheel(); }
        };

        els.removeCheckbox.onchange = (e) => { state.removeOnWin = e.target.checked; updateUIFromSettings(); };
        els.soundCheckbox.onchange = (e) => { state.soundEnabled = e.target.checked; updateUIFromSettings(); };

        els.spinBtn.onclick = () => {
            const active = state.items.filter(i => i.checked);
            if (state.isSpinning || active.length === 0) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            state.isSpinning = true;
            els.spinBtn.disabled = true;
            els.winnerDisplay.classList.replace('animate-prize', 'opacity-0');
            state.rotation += 3600 + Math.floor(Math.random() * 360);
            els.wheelLayer.style.transition = 'transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)';
            els.wheelLayer.style.transform = `rotate(${state.rotation}deg)`;
            state.lastTickIndex = -1;
            monitorTicks(active.length);
            setTimeout(() => {
                state.isSpinning = false;
                const winningIndex = Math.floor((((90 - (state.rotation % 360)) % 360 + 360) % 360) / (360 / active.length));
                const winner = active[winningIndex];
                els.winnerName.textContent = winner.text;
                els.winnerDisplay.classList.replace('opacity-0', 'animate-prize');
                triggerCelebrate();
                if (state.removeOnWin) setTimeout(() => { winner.checked = false; renderList(); renderWheel(); }, 2000);
                els.spinBtn.disabled = false;
            }, 4000);
        };

        // --- 初始化 ---
        renderList();
        renderWheel();
        updateUIFromSettings();
        els.body.style.backgroundColor = state.bgColor;
    </script>
</body>
</html>