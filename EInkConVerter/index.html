<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Color E-Ink Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for range inputs */
        input[type=range] {
            -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
            width: 100%; /* Specific width is required for Firefox. */
            background: transparent; /* Otherwise white in Chrome */
            height: 24px; /* Ensure enough touch area */
            padding: 0;
            margin: 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4f46e5; /* indigo-600 */
            cursor: pointer;
            margin-top: -8px; /* Center thumb on track: (24px - 8px) / -2 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0; /* slate-200 */
            border-radius: 9999px;
        }

        input[type=range]:focus {
            outline: none;
        }
        
        /* Firefox Styles */
        input[type=range]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border: 2px solid white;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 9999px;
        }

        /* Hide scrollbar for cleaner UI on mobile */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100 pb-20">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="zap" width="20" height="20"></i>
                </div>
                <h1 class="text-lg sm:text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 truncate">
                    7-Color E-Ink Converter
                </h1>
            </div>
            <div class="text-xs sm:text-sm text-slate-500 hidden sm:block">
                專為 ACEP 7色電子紙設計 (Hardware Mode)
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 sm:py-8">
        
        <!-- Palette Display -->
        <div class="mb-6 sm:mb-8 bg-white p-4 rounded-xl border border-slate-200 shadow-sm overflow-x-auto no-scrollbar">
            <h2 class="text-xs sm:text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2 whitespace-nowrap">
                <i data-lucide="info" width="16" height="16"></i> 輸出色彩映射 (Output Mapping)
            </h2>
            <div class="flex sm:grid sm:grid-cols-4 md:grid-cols-7 gap-3 min-w-max sm:min-w-0" id="palette-container">
                <!-- Palette items will be injected here by JS -->
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
          
            <!-- Left: Controls & Upload -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Upload Zone -->
                <div class="bg-white p-6 rounded-2xl border-2 border-dashed border-slate-300 hover:border-indigo-400 transition-colors text-center group cursor-pointer relative overflow-hidden active:bg-slate-50">
                    <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                    <div class="flex flex-col items-center justify-center py-4 sm:py-8">
                        <div class="bg-indigo-50 text-indigo-600 p-4 rounded-full mb-4 group-hover:scale-110 transition-transform">
                            <i data-lucide="upload" width="32" height="32"></i>
                        </div>
                        <p class="text-lg font-semibold text-slate-700">上傳圖片</p>
                        <p class="text-slate-400 text-sm mt-1">支援 JPG, PNG, WebP</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-white p-5 sm:p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                    <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-4">
                        <i data-lucide="settings" width="20" height="20" class="text-slate-400"></i>
                        <h3 class="font-bold text-slate-800">轉換設定</h3>
                    </div>

                    <!-- Dithering Toggle -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-slate-700">演算法</label>
                            <span id="dithering-label" class="text-xs text-indigo-600 font-medium bg-indigo-50 px-2 py-1 rounded-full">
                                Floyd-Steinberg 抖動
                            </span>
                        </div>
                        <button id="dithering-btn" class="w-full py-3 px-4 rounded-lg border text-sm font-medium transition-all bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700 active:scale-[0.98]">
                            已開啟抖動 (適合照片)
                        </button>
                        <p class="text-xs text-slate-400 mt-2">
                            抖動可以讓照片在有限色彩下顯示更多細節，但會產生雜點。
                        </p>
                    </div>

                    <!-- Width -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            輸出寬度 (px)
                        </label>
                        <input type="number" id="width-input" value="800" class="w-full px-3 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-lg">
                    </div>

                    <!-- Brightness -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">亮度</label>
                            <span id="brightness-val" class="text-xs text-slate-500">0%</span>
                        </div>
                        <input type="range" id="brightness-input" min="-100" max="100" value="0" class="w-full appearance-none bg-transparent cursor-pointer">
                    </div>

                    <!-- Contrast -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">對比度</label>
                            <span id="contrast-val" class="text-xs text-slate-500">0%</span>
                        </div>
                        <input type="range" id="contrast-input" min="-100" max="100" value="0" class="w-full appearance-none bg-transparent cursor-pointer">
                    </div>

                    <button id="reset-btn" class="flex items-center justify-center gap-2 w-full text-sm text-slate-500 hover:text-slate-800 py-3 active:bg-slate-50 rounded-lg">
                        <i data-lucide="refresh-cw" width="14" height="14"></i> 重置設定
                    </button>
                </div>
            </div>

            <!-- Right: Preview Area -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Processed View -->
                <div class="bg-white p-2 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between px-4 py-3 border-b border-slate-100 mb-2 gap-3">
                        <div class="flex items-center gap-2">
                            <i data-lucide="image" width="20" height="20" class="text-indigo-600"></i>
                            <h3 class="font-bold text-slate-800">預覽結果 (硬體訊號色)</h3>
                        </div>
                        <button id="download-btn" class="hidden flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors w-full sm:w-auto justify-center shadow-md active:bg-indigo-800">
                            <i data-lucide="download" width="16" height="16"></i> 下載圖片
                        </button>
                    </div>

                    <div class="relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-slate-100 min-h-[300px] sm:min-h-[400px] flex items-center justify-center rounded-xl overflow-hidden border border-slate-100">
                        
                        <!-- Loading Overlay -->
                        <div id="loading-overlay" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                            <i data-lucide="refresh-cw" width="32" height="32" class="animate-spin text-indigo-600 mb-2"></i>
                            <span class="text-sm font-medium text-indigo-600">正在轉換色彩...</span>
                        </div>

                        <!-- Empty State -->
                        <div id="empty-state" class="text-center text-slate-400 p-10">
                            <i data-lucide="image" width="48" height="48" class="mx-auto mb-3 opacity-50"></i>
                            <p>請先上傳圖片以開始轉換</p>
                        </div>

                        <!-- Image Result -->
                        <img id="processed-img" class="hidden max-w-full h-auto shadow-lg" style="image-rendering: pixelated;" alt="Processed">
                    </div>
                    
                    <!-- Original Image thumbnail -->
                    <div id="original-preview-container" class="hidden mt-4 px-4 pb-2">
                        <p class="text-xs font-semibold text-slate-500 mb-2">原始圖片參考：</p>
                        <div class="h-20 w-20 rounded-lg overflow-hidden border border-slate-200 relative group">
                            <img id="original-img" class="w-full h-full object-cover" alt="Original">
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 flex gap-3">
                    <i data-lucide="alert-circle" width="20" height="20" class="text-amber-600 shrink-0 mt-0.5"></i>
                    <div class="text-sm text-amber-800">
                        <h4 class="font-bold mb-1">為什麼預覽圖片看起來顏色很亮？</h4>
                        <p>
                        根據您的硬體需求：<br>
                        • 視覺上的 <b>深綠色 (#007F00)</b> 已被映射為訊號 <b>亮綠色 (#00FF00)</b><br>
                        • 視覺上的 <b>深藍色 (#00007F)</b> 已被映射為訊號 <b>純藍色 (#0000FF)</b><br>
                        請直接下載圖片，當傳輸到電子墨水屏時，硬體會顯示出正確的深色調。
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // Init Icons
        lucide.createIcons();

        // --- Config ---
        const EINK_PALETTE = [
            { hex: '#FFFFFF', r: 255, g: 255, b: 255, outR: 255, outG: 255, outB: 255, name: 'White' },
            { hex: '#000000', r: 0,   g: 0,   b: 0,   outR: 0,   outG: 0,   outB: 0,   name: 'Black' },
            { hex: '#FF0000', r: 255, g: 0,   b: 0,   outR: 255, outG: 0,   outB: 0,   name: 'Red' },
            { hex: '#FF7F00', r: 255, g: 127, b: 0,   outR: 255, outG: 127, outB: 0,   name: 'Orange' },
            { hex: '#FFFF00', r: 255, g: 255, b: 0,   outR: 255, outG: 255, outB: 0,   name: 'Yellow' },
            // Green: Visual Dark Green (#007F00), Output Lime Green (#00FF00)
            { hex: '#007F00', r: 0,   g: 127, b: 0,   outR: 0,   outG: 255, outB: 0,   name: 'Green' }, 
            // Blue: Visual Dark Blue (#00007F), Output Blue (#0000FF)
            { hex: '#00007F', r: 0,   g: 0,   b: 127, outR: 0,   outG: 0,   outB: 255, name: 'Blue' },  
        ];

        // --- State ---
        let state = {
            originalImageSrc: null,
            isProcessing: false,
            useDithering: true,
            brightness: 0,
            contrast: 0,
            outputWidth: 800,
            maintainAspect: true
        };

        // --- Elements ---
        const els = {
            fileInput: document.getElementById('fileInput'),
            ditheringBtn: document.getElementById('dithering-btn'),
            ditheringLabel: document.getElementById('dithering-label'),
            widthInput: document.getElementById('width-input'),
            brightnessInput: document.getElementById('brightness-input'),
            brightnessVal: document.getElementById('brightness-val'),
            contrastInput: document.getElementById('contrast-input'),
            contrastVal: document.getElementById('contrast-val'),
            resetBtn: document.getElementById('reset-btn'),
            downloadBtn: document.getElementById('download-btn'),
            
            // Views
            loadingOverlay: document.getElementById('loading-overlay'),
            emptyState: document.getElementById('empty-state'),
            processedImg: document.getElementById('processed-img'),
            originalPreviewContainer: document.getElementById('original-preview-container'),
            originalImg: document.getElementById('original-img'),
            paletteContainer: document.getElementById('palette-container')
        };

        // --- Init UI ---
        function initPalette() {
            els.paletteContainer.innerHTML = EINK_PALETTE.map(color => {
                const isDifferent = (color.r !== color.outR || color.g !== color.outG || color.b !== color.outB);
                const outHex = '#' + ((1 << 24) + (color.outR << 16) + (color.outG << 8) + color.outB).toString(16).slice(1).toUpperCase();
                
                return `
                <div class="flex flex-none items-center gap-2 p-2 rounded-lg border border-slate-100 bg-slate-50 min-w-[140px] sm:min-w-0">
                    <div class="flex flex-col items-center gap-1">
                        <!-- Visual Color -->
                        <div class="w-8 h-8 rounded-full shadow-sm border border-slate-200 ring-2 ring-white"
                             style="background-color: rgb(${color.r},${color.g},${color.b})"
                             title="螢幕顯示顏色"></div>
                        ${isDifferent ? `
                        <div class="text-[10px] text-slate-400">⬇</div>
                        <div class="w-4 h-4 rounded-full shadow-sm border border-slate-200"
                             style="background-color: rgb(${color.outR},${color.outG},${color.outB})"
                             title="檔案輸出顏色"></div>
                        ` : ''}
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-slate-700">${color.name}</span>
                        <span class="text-[10px] text-slate-400 font-mono">Out: ${outHex}</span>
                    </div>
                </div>
                `;
            }).join('');
        }
        initPalette();

        // --- Logic ---

        function getColorDistance(r1, g1, b1, r2, g2, b2) {
            return Math.pow(r2 - r1, 2) + Math.pow(g2 - g1, 2) + Math.pow(b2 - b1, 2);
        }

        function getNearestColor(r, g, b) {
            let minDistance = Infinity;
            let nearest = EINK_PALETTE[0];

            for (let i = 0; i < EINK_PALETTE.length; i++) {
                const color = EINK_PALETTE[i];
                // Compare with Visual Color
                const dist = getColorDistance(r, g, b, color.r, color.g, color.b);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearest = color;
                }
            }
            return nearest;
        }

        function triggerProcess() {
            if (!state.originalImageSrc) return;
            
            // Show Loading
            els.loadingOverlay.classList.remove('hidden');
            
            // Use setTimeout to allow UI to update (show loading spinner) before heavy calculation
            setTimeout(() => {
                processImage();
            }, 50);
        }

        function processImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = () => {
                // 1. Setup Size
                let targetWidth = state.outputWidth;
                let targetHeight = img.height * (state.outputWidth / img.width);
                
                canvas.width = targetWidth;
                canvas.height = targetHeight;

                // 2. Filter & Draw
                // Use canvas filter for brightness/contrast
                ctx.filter = `brightness(${100 + state.brightness}%) contrast(${100 + state.contrast}%)`;
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                ctx.filter = 'none';

                // 3. Get Data
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;

                // 4. Pixel Loop
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        
                        const oldR = data[idx];
                        const oldG = data[idx + 1];
                        const oldB = data[idx + 2];
                        
                        // Find Nearest (Visual)
                        const nearest = getNearestColor(oldR, oldG, oldB);

                        // Set Output (Signal)
                        data[idx] = nearest.outR;
                        data[idx + 1] = nearest.outG;
                        data[idx + 2] = nearest.outB;
                        data[idx + 3] = 255; // Alpha

                        // Dithering (Floyd-Steinberg)
                        if (state.useDithering) {
                            // Calculate Error based on Visual Color
                            const errR = oldR - nearest.r;
                            const errG = oldG - nearest.g;
                            const errB = oldB - nearest.b;

                            const distributeError = (offsetX, offsetY, factor) => {
                                if (x + offsetX >= 0 && x + offsetX < width && y + offsetY >= 0 && y + offsetY < height) {
                                    const nIdx = ((y + offsetY) * width + (x + offsetX)) * 4;
                                    data[nIdx]     = Math.min(255, Math.max(0, data[nIdx]     + errR * factor));
                                    data[nIdx + 1] = Math.min(255, Math.max(0, data[nIdx + 1] + errG * factor));
                                    data[nIdx + 2] = Math.min(255, Math.max(0, data[nIdx + 2] + errB * factor));
                                }
                            };

                            distributeError(1, 0, 7/16);
                            distributeError(-1, 1, 3/16);
                            distributeError(0, 1, 5/16);
                            distributeError(1, 1, 1/16);
                        }
                    }
                }

                // 5. Output
                ctx.putImageData(imageData, 0, 0);
                const resultUrl = canvas.toDataURL('image/png');
                
                // Update UI
                els.processedImg.src = resultUrl;
                els.processedImg.classList.remove('hidden');
                els.emptyState.classList.add('hidden');
                els.downloadBtn.classList.remove('hidden');
                els.downloadBtn.classList.add('flex'); // Ensure flex is added back
                els.loadingOverlay.classList.add('hidden');
            };

            img.src = state.originalImageSrc;
        }

        // --- Event Listeners ---

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    state.originalImageSrc = event.target.result;
                    els.originalImg.src = state.originalImageSrc;
                    els.originalPreviewContainer.classList.remove('hidden');
                    triggerProcess();
                };
                reader.readAsDataURL(file);
            }
        });

        els.ditheringBtn.addEventListener('click', () => {
            state.useDithering = !state.useDithering;
            // Update Button UI
            if (state.useDithering) {
                els.ditheringBtn.textContent = '已開啟抖動 (適合照片)';
                els.ditheringBtn.classList.replace('bg-white', 'bg-indigo-600');
                els.ditheringBtn.classList.replace('text-slate-600', 'text-white');
                els.ditheringBtn.classList.replace('border-slate-300', 'border-indigo-600');
                els.ditheringBtn.classList.replace('hover:bg-slate-50', 'hover:bg-indigo-700');
                els.ditheringLabel.textContent = 'Floyd-Steinberg 抖動';
            } else {
                els.ditheringBtn.textContent = '關閉抖動 (適合圖表/色塊)';
                els.ditheringBtn.classList.replace('bg-indigo-600', 'bg-white');
                els.ditheringBtn.classList.replace('text-white', 'text-slate-600');
                els.ditheringBtn.classList.replace('border-indigo-600', 'border-slate-300');
                els.ditheringBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-slate-50');
                els.ditheringLabel.textContent = '最近鄰轉換';
            }
            triggerProcess();
        });

        els.widthInput.addEventListener('change', (e) => {
            state.outputWidth = Number(e.target.value);
            triggerProcess();
        });

        els.brightnessInput.addEventListener('input', (e) => {
            state.brightness = Number(e.target.value);
            els.brightnessVal.textContent = state.brightness + '%';
        });
        // Only trigger process on change (release slider) to avoid lag
        els.brightnessInput.addEventListener('change', triggerProcess);

        els.contrastInput.addEventListener('input', (e) => {
            state.contrast = Number(e.target.value);
            els.contrastVal.textContent = state.contrast + '%';
        });
        els.contrastInput.addEventListener('change', triggerProcess);

        els.resetBtn.addEventListener('click', () => {
            state.brightness = 0;
            state.contrast = 0;
            state.outputWidth = 800;
            state.useDithering = true;
            
            // Reset UI Values
            els.brightnessInput.value = 0;
            els.brightnessVal.textContent = '0%';
            els.contrastInput.value = 0;
            els.contrastVal.textContent = '0%';
            els.widthInput.value = 800;
            
            // Reset Dithering Button UI
            els.ditheringBtn.textContent = '已開啟抖動 (適合照片)';
            els.ditheringBtn.classList.remove('bg-white', 'text-slate-600', 'border-slate-300', 'hover:bg-slate-50');
            els.ditheringBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600', 'hover:bg-indigo-700');
            els.ditheringLabel.textContent = 'Floyd-Steinberg 抖動';

            triggerProcess();
        });

        els.downloadBtn.addEventListener('click', () => {
            if (!els.processedImg.src) return;
            const link = document.createElement('a');
            link.href = els.processedImg.src;
            link.download = 'eink-converted.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>